server {
  listen 80;
  
  # Proxy API requests through the ALB
  # REPLACE the URL below with your actual ALB DNS
  # Get it with: aws cloudformation describe-stacks --stack-name ecs-trial-alb --query 'Stacks[0].Outputs[?OutputKey==`LoadBalancerDNS`].OutputValue' --output text
  
  location /api/ {
    # Replace YOUR-ALB-DNS-HERE with your actual ALB DNS
    proxy_pass http://ecs-trial-alb-1166976674.eu-west-1.elb.amazonaws.com/;
    
    # Standard proxy headers
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    
    # Don't buffer, for real-time streaming if needed
    proxy_buffering off;
  }

  # Serve static frontend files
  location / {
    root /usr/share/nginx/html;
    index index.html index.htm;
    try_files $uri $uri/ /index.html =404;
  }
  
  include /etc/nginx/extra-conf.d/*.conf;
}

# Kubernetes / Local Development version

# server {
#   listen 80;
  
#   location /api/ {
#     proxy_pass http://tasks-service.default:8000/;
#     proxy_pass http://host.docker.internal:8000/;
#     proxy_pass http://tasks:8000/;
#     proxy_pass http://tasks-service.ecs-trial.local:8000/;
#   }

#   location / {
#     root /usr/share/nginx/html;
#     index index.html index.htm;
#     try_files $uri $uri/ /index.html =404;
#   }
  
#   include /etc/nginx/extra-conf.d/*.conf;
# }

# Docker Compose / Local Development version

# server {
#   listen 80;
  
#   # Proxy to tasks service (matches both /api/tasks and /api/tasks/)
#   location /api/tasks {
#     proxy_pass http://tasks:8000/api/tasks;
#     proxy_http_version 1.1;
#     proxy_set_header Host $host;
#     proxy_set_header X-Real-IP $remote_addr;
#     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#     proxy_set_header X-Forwarded-Proto $scheme;
#   }
  
#   # Proxy to users service
#   location /api/users {
#     proxy_pass http://users:8080/api/users;
#     proxy_http_version 1.1;
#     proxy_set_header Host $host;
#     proxy_set_header X-Real-IP $remote_addr;
#     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#   }
  
#   # Proxy to auth service
#   location /api/auth {
#     proxy_pass http://auth:80/api/auth;
#     proxy_http_version 1.1;
#     proxy_set_header Host $host;
#     proxy_set_header X-Real-IP $remote_addr;
#     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#   }

#   # Serve static frontend files
#   location / {
#     root /usr/share/nginx/html;
#     index index.html index.htm;
#     try_files $uri $uri/ /index.html =404;
#   }
  
#   include /etc/nginx/extra-conf.d/*.conf;
# }
